<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baseball Pitch Probability Predictor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        form { display: grid; gap: 10px; }
        #results { margin-top: 20px; border: 1px solid #ccc; padding: 15px; }
        #probs-list { list-style: none; padding: 0; }
        #probs-list li { margin-bottom: 5px; }
        #summary { margin-top: 20px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>Baseball Pitch Probability Predictor</h1>
    <p>Enter the situation details (inning and bases are optional). We'll look up probabilities and use DeepSeek AI for a summary.</p>
    
    <form id="input-form">
        <label>Balls (0-3):
            <select id="balls">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
            </select>
        </label>
        <label>Strikes (0-2):
            <select id="strikes">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
            </select>
        </label>
        <label>Outs (0-2):
            <select id="outs">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
            </select>
        </label>
        <label>Inning (optional, 1+):
            <input type="number" id="inning" min="1" placeholder="e.g., 5">
        </label>
        <fieldset>
            <legend>Bases (optional):</legend>
            <label><input type="checkbox" id="base1"> Runner on 1st</label>
            <label><input type="checkbox" id="base2"> Runner on 2nd</label>
            <label><input type="checkbox" id="base3"> Runner on 3rd</label>
        </fieldset>
        <button type="button" onclick="getPrediction()">Get Prediction</button>
    </form>
    
    <div id="results" style="display: none;">
        <h2>Probabilities</h2>
        <ul id="probs-list"></ul>
        <h2>AI Summary</h2>
        <div id="summary"></div>
    </div>

    <script>
        const DEEPSEEK_API_KEY = "sk-457f3a9291c74e9589c87eb822c98ae6";  // Your key here (visible in source)

        async function fetchCSV(url) {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Failed to load ${url}: ${response.status}`);
            }
            const csvText = await response.text();
            return Papa.parse(csvText, { header: true, skipEmptyLines: true }).data;
        }

        async function getPrediction() {
            const b = document.getElementById('balls').value;
            const s = document.getElementById('strikes').value;
            const o = document.getElementById('outs').value;
            const inning = document.getElementById('inning').value || '';
            const on1 = document.getElementById('base1').checked ? 1 : 0;
            const on2 = document.getElementById('base2').checked ? 1 : 0;
            const on3 = document.getElementById('base3').checked ? 1 : 0;
            const base_state = `${on1}-${on2}-${on3}`;

            const expanded_url = 'https://raw.githubusercontent.com/viki-m13/baseprobs/main/expanded_probabilities.csv';
            const bso_url = 'https://raw.githubusercontent.com/viki-m13/baseprobs/main/bs_o_probabilities.csv';

            let row = null;
            let source = 'expanded';

            // Try expanded first if inning and/or bases provided
            if (inning || base_state !== '0-0-0') {
                try {
                    const expanded_data = await fetchCSV(expanded_url);
                    row = expanded_data.find(r => 
                        r.B == b && r.S == s && r.O == o && 
                        (!inning || r.inning == inning) && 
                        (base_state === '0-0-0' || r.base_state == base_state)
                    );
                } catch (err) {
                    console.error('Expanded CSV load error:', err);
                }
            }

            // Fallback to B-S-O
            if (!row) {
                source = 'bso';
                try {
                    const bso_data = await fetchCSV(bso_url);
                    row = bso_data.find(r => r.B == b && r.S == s && r.O == o);
                } catch (err) {
                    console.error('BSO CSV load error:', err);
                }
            }

            if (!row) {
                alert('No matching data found. Check console (F12) for errorsâ€”likely CSVs not uploaded.');
                return;
            }

            // Display probabilities
            const probsList = document.getElementById('probs-list');
            probsList.innerHTML = '';
            const probKeys = ['P(Swing)', 'P(Contact)', 'P(Whiff)', 'P(Foul)', 'P(Ball)', 'P(Strike)', 'P(Hit)', 'P(Out)', 'P(Struck Out)', 'P(Home Run)', 'P(Extra Base Hit)', 'P(In Play)', 'P(Walk)', 'P(Hit By Pitch)', 'P(Error)', 'P(Sacrifice)'];
            probKeys.forEach(key => {
                const li = document.createElement('li');
                li.textContent = `${key.replace('P(', '').replace(')', '')}: ${row[key]}`;
                probsList.appendChild(li);
            });
            const liRel = document.createElement('li');
            liRel.textContent = `Statistically Relevant: ${row['Statistically Relevant']}`;
            probsList.appendChild(liRel);
            if (source === 'bso') {
                const liSource = document.createElement('li');
                liSource.textContent = '(Using B-S-O fallback; no exact expanded match)';
                probsList.appendChild(liSource);
            }

            document.getElementById('results').style.display = 'block';

            // Construct prompt for DeepSeek
            const situation = `Balls: ${b}, Strikes: ${s}, Outs: ${o}${inning ? `, Inning: ${inning}` : ''}${base_state !== '0-0-0' ? `, Bases: ${base_state} (1-0-0 means runner on 1st, etc.)` : ''}`;
            let probsText = 'Probabilities:\n';
            probKeys.forEach(key => {
                probsText += `${key}: ${row[key]}\n`;
            });
            probsText += `Statistically Relevant: ${row['Statistically Relevant']}\n`;
            const prompt = `Based on historical baseball data for this situation:\n${situation}\n\n${probsText}\nUsing reasoning, provide a brief summary of what is likely to happen on the next pitch, including key probabilities and an overall idea of the outcome. Keep it concise.`;

            // Call DeepSeek API directly
            try {
                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${DEEPSEEK_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            { role: 'system', content: 'You are a baseball analyst providing insights based on probabilities.' },
                            { role: 'user', content: prompt }
                        ],
                        max_tokens: 500,
                        temperature: 0.7
                    })
                });
                if (!response.ok) {
                    throw new Error(`API error: ${response.statusText}`);
                }
                const data = await response.json();
                document.getElementById('summary').textContent = data.choices[0].message.content;
            } catch (err) {
                document.getElementById('summary').textContent = `Error: ${err.message}. Check your API key or network.`;
            }
        }
    </script>
</body>
</html>
